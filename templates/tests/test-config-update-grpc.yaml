apiVersion: v1
kind: Pod
metadata:
  name: "{{ include "skyramp-mocker.fullname" . }}-test-config-grpc"
  annotations:
    "helm.sh/hook": test
spec:
  containers:
    # Add proto file
    - name: add-proto-file 
      image: curlimages/curl:7.87.0
      command: 
        - "/bin/sh"
        - "-c"
        - |
          cat << EOF > /tmp/helloworld.proto
          {{ include "skyramp-mocker-test.demo-proto" . | nindent 11 }}
          EOF

          cat << EOF > /tmp/helloworld.yaml
          {{ include "skyramp-mocker-test.grpcPayload" . | nindent 11 }}
          EOF

          curl -XPUT {{ include "skyramp-mocker.fullname" . }}:{{ .Values.service.port }}/skyramp/mocks -F "mockFiles=@/tmp/helloworld.proto"
          sleep 20
          curl -XPUT {{ include "skyramp-mocker.fullname" . }}:{{ .Values.service.port }}/skyramp/mocks -F "mockFiles=@/tmp/helloworld.proto" -F "mockDescription=@/tmp/helloworld.yaml"
  restartPolicy: Never